
@{
    ViewBag.Title = "Index";
}
<link href="~/Content/Site.css" rel="stylesheet" />

@using (Html.BeginForm("SubmitStageResult", "Stage", FormMethod.Post, new { }))
{
    <input name="index" style="display:none;" value="@ViewBag.Current.StageId" />
    <input name="isNext" style="display:none;" value="0" />
    <input name="speed" style="display:none;" value="0" />
    <input name="mistakes" style="display:none;" value="0" />
    <input name="rating" style="display:none;" value="0" />
    <div class="white-box" id="result-box">
        <div class="grey-line">
            <h2>Результат урока</h2>
            <p class="text-p">Скорость печати:<span class="text-span" id="speed"> &nbsp 12</span> знаков/мин</p>
            <p class="text-p">Количество ошибок:<span class="text-span" id="mistakes"> &nbsp 1</span></p>
            <p class="text-p">Рейтинг:<span class="text-span" id="rating"> &nbsp 1</span></p>
            <div class="row">
                <div class="col-xs-6">
                    <a href="../../Home" id="all-btn" style="width:100%;margin:0; " class="btn stage-start-btn">Ко всем урокам</a>
                </div>
                <div class="col-xs-6">

                    <button type="submit" style="width:100%; margin:0;" id="next-btn" class="btn stage-start-btn">Далее</button>
                    @*<button type="submit" href="../../Stage/Index/@(ViewBag.Current.StageId)" style="width:100%; margin:0; display:none;" id="again-btn" class="btn stage-start-btn">Заново</button>*@

                </div>
            </div>
        </div>
    </div>
}
    <div class="white-box" style="display:block; height:inherit;" id="start-box">
        <div class="grey-line">
            <div class="stage-name">Урок @ViewBag.Current.StageId: @ViewBag.Current.StageName</div>
            <div class="passed-stage">
                @{ int full = ViewBag.Current.Complexity; int empty = 5 - full;}
                <span>Сложность</span><p class="stage-complexity">
                    @while (empty > 0)
                    {
                        <i class=" fa fa-star"></i>
                        --empty;
                    }
                    @while (full > 0)
                    {
                        <i class="fa fa-star-o"></i>
                        --full;
                    }

                </p>
                @if (!ViewBag.IsPass)
                {
                    <span class="is-pass">Не пройден <i class="fa fa-pencil" style="color:red;"></i></span>
                }
                else
                {
                    <span class="is-pass">Пройдено с рейтингом @ViewBag.Passed.Rating<i class="fa fa-check" style="color:green;"></i></span>
                }
            </div>
            <div class="stage-advice ">@ViewBag.Current.Advice</div><div class="passed-stage">
            <button class="btn login-btn"  onclick="document.getElementById('start-box').style.display = 'none';">Начать</button>
                
                </div>
            </div>
    </div>
<div style="height:50px;"></div>

<div class="">
    
    <div class="container ">
        <div class="col-xs-4 stage-desc">
            <div class="">Максимум ошибок: @ViewBag.Current.MaximalMistakes</div>
        </div>
        <div class="col-xs-4 stage-desc">
            <div class="">Допущено ошибок: <span id="mst">0</span></div>
        </div>
        <div class="col-xs-4 stage-desc">
            <div class="">Минимальная скорость: @ViewBag.Current.MinimalSpeed</div>
        </div>
    </div>
</div>

<div class="keyboard-container">
    <div class="container ">

        <div class="display">

            <div class="field">
                <span id="done" class="done"></span>
                <span id="cursor" class="fCursor"></span>
                <span id="not-done" class="not-done">@ViewBag.Current.TextToType</span>
            </div>
        </div>
        <div class="row"></div>

        <div id="kb1" class="keyboard table">
            <div>
                <div class="key letter">ё</div>
                <div class="key key1" id="1">1</div>
                <div class="key key1" id="2">2</div>
                <div class="key key2" id="3">3</div>
                <div class="key key3" id="4">4</div>
                <div class="key key4" id="5">5</div>
                <div class="key key4" id="6">6</div>
                <div class="key key5" id="7">7</div>
                <div class="key key3" id="8">8</div>
                <div class="key key2" id="9">9</div>
                <div class="key key1" id="0">0</div>
                <div class="key key1" id="-">-</div>
                <div class="key key1" id="=">=</div>
                <div class="key" style="width:70px;">←</div>
            </div>
            <div>
                <div class="key " style="width:70px; padding-left:12px; text-align:left;">Tab</div>
                <div class="key key1 letter" id="й">й</div>
                <div class="key key2 letter" id="ц">ц</div>
                <div class="key key3 letter" id="у">у</div>
                <div class="key key4 letter" id="к">к</div>
                <div class="key key4 letter" id="е">е</div>
                <div class="key key5 letter" id="н">н</div>
                <div class="key key5 letter" id="г">г</div>
                <div class="key key3 letter" id="ш">ш</div>
                <div class="key key2 letter" id="щ">щ</div>
                <div class="key key1 letter" id="з">з</div>
                <div class="key key1 letter" id="х">х</div>
                <div class="key key1 letter" id="ъ">ъ</div>
                <div class="key" id="\">\</div>
            </div>
            <div>
                <div class="key " style="width:83px; padding-left:12px; text-align:left;" id="Caps">Caps</div>
                <div class="key key1 letter" id="ф">ф</div>
                <div class="key key2 letter" id="ы">ы</div>
                <div class="key key3 letter" id="в">в</div>
                <div class="key key4 letter" id="а">а</div>
                <div class="key key4 letter" id="п">п</div>
                <div class="key key5 letter" id="р">р</div>
                <div class="key key5 letter" id="о">о</div>
                <div class="key key3 letter" id="л">л</div>
                <div class="key key2 letter" id="д">д</div>
                <div class="key key1 letter" id="ж">ж</div>
                <div class="key key1 letter" id="э">э</div>
                <div class="key " style="width:86px; padding-right:12px; text-align:right;" id="Enter">Enter</div>
            </div>
            <div>
                <div class="key " style="width:110px;  padding-left:12px; text-align:left;" id="Shift">Shift</div>
                <div class="key key1 letter" id="я">я</div>
                <div class="key key2 letter" id="ч">ч</div>
                <div class="key key3 letter" id="с">с</div>
                <div class="key key4 letter" id="м">м</div>
                <div class="key key4 letter" id="и">и</div>
                <div class="key key5 letter" id="т">т</div>
                <div class="key key5 letter" id="ь">ь</div>
                <div class="key key3 letter" id="б">б</div>
                <div class="key key2 letter" id="ю">ю</div>
                <div class="key key1" id=".">.</div>
                <div class="key " style="width:109px; padding-right:12px; text-align:right;" id="Shift">Shift</div>
            </div>
            <div style="text-align:center;">
                <div class="key " style="width:270px; " id="Space1"></div>
            </div>

        </div>

        <div id="kb2" class="keyboard table" style="display:none;">
            <div>
                <div class="key letter">Ё</div>
                <div class="key key1" id="!">!</div>
                <div class="key key1" id='"'>"</div>
                <div class="key key2" id="№">№</div>
                <div class="key key3" id=";">;</div>
                <div class="key key4" id="%">%</div>
                <div class="key key4" id=":">:</div>
                <div class="key key5" id="?">?</div>
                <div class="key key3" id="*">*</div>
                <div class="key key2" id="(">(</div>
                <div class="key key1" id=")">)</div>
                <div class="key key1" id="_">_</div>
                <div class="key key1" id="+">+</div>
                <div class="key" style="width:70px;">←</div>
            </div>
            <div>
                <div class="key " style="width:70px; padding-left:12px; text-align:left;">Tab</div>
                <div class="key key1 letter" id="Й">Й</div>
                <div class="key key2 letter" id="Ц">Ц</div>
                <div class="key key3 letter" id="У">У</div>
                <div class="key key4 letter" id="К">К</div>
                <div class="key key4 letter" id="Е">Е</div>
                <div class="key key5 letter" id="Н">Н</div>
                <div class="key key5 letter" id="Г">Г</div>
                <div class="key key3 letter" id="Ш">Ш</div>
                <div class="key key2 letter" id="Щ">Щ</div>
                <div class="key key1 letter" id="З">З</div>
                <div class="key key1 letter" id="Х">Х</div>
                <div class="key key1 letter" id="Ъ">Ъ</div>
                <div class="key" id="/">/</div>
            </div>
            <div>
                <div class="key " style="width:83px; padding-left:12px; text-align:left;" id="Caps">Caps</div>
                <div class="key key1 letter" id="Ф">Ф</div>
                <div class="key key2 letter" id="Ы">Ы</div>
                <div class="key key3 letter" id="В">В</div>
                <div class="key key4 letter" id="А">А</div>
                <div class="key key4 letter" id="П">П</div>
                <div class="key key5 letter" id="Р">Р</div>
                <div class="key key5 letter" id="О">О</div>
                <div class="key key3 letter" id="Л">Л</div>
                <div class="key key2 letter" id="Д">Д</div>
                <div class="key key1 letter" id="Ж">Ж</div>
                <div class="key key1 letter" id="Э">Э</div>
                <div class="key " style="width:86px; padding-right:12px; text-align:right;" id="Enter">Enter</div>
            </div>
            <div>
                <div class="key " style="width:110px;  padding-left:12px; text-align:left;" id="Shift">Shift</div>
                <div class="key key1 letter" id="Я">Я</div>
                <div class="key key2 letter" id="Ч">Ч</div>
                <div class="key key3 letter" id="С">С</div>
                <div class="key key4 letter" id="М">М</div>
                <div class="key key4 letter" id="И">И</div>
                <div class="key key5 letter" id="Т">Т</div>
                <div class="key key5 letter" id="Ь">Ь</div>
                <div class="key key3 letter" id="Б">Б</div>
                <div class="key key2 letter" id="Ю">Ю</div>
                <div class="key key1" id=",">,</div>
                <div class="key " style="width:109px; padding-right:12px; text-align:right;" id="Shift">Shift</div>
            </div>
            <div style="text-align:center;">
                <div class="key " style="width:270px; " id="Space2"></div>
            </div>

        </div>
    </div>
</div>

<div id="secret" style="visibility:hidden">@ViewBag.Current.TextToType</div>
<script>
    var maxMist = Number(@ViewBag.Current.MaximalMistakes);
    var minSpeed = Number(@ViewBag.Current.MinimalSpeed);
    var timeSpan = Number(0);
    var isTyping = "f";
    var Mistakes = 0;
    var speed = 0;
    var rating = 0;

    function ShowResult() {

        speed = (document.getElementById('done').innerText.length / timeSpan) * 600;

        if (speed >= minSpeed && Mistakes <= maxMist) {
            document.getElementById("speed").innerHTML = " &nbsp " + Math.round(speed);
            document.getElementById("mistakes").innerHTML = " &nbsp " + Mistakes;

            document.getElementsByName("speed")[0].value = Math.round(speed);

            document.getElementsByName("mistakes")[0].value = Mistakes;
            document.getElementsByName("rating")[0].value = Math.round((speed - minSpeed) * 0.7 + 150 - 15 * Mistakes);
            document.getElementsByName('isNext')[0].value = 1;


            document.getElementById("rating").innerHTML = " &nbsp " + document.getElementsByName("rating")[0].value;


            document.getElementById("result-box").style.display = "block";
        }
        else {
            document.getElementById("speed").innerHTML = " &nbsp " + Math.round(speed);
            document.getElementById("mistakes").innerHTML = " &nbsp " + Mistakes;
            document.getElementById("rating").innerHTML = " &nbsp " + 0;

            document.getElementById("rating").style.color = "red";

            if (speed < minSpeed)
            { document.getElementById("speed").style.color = "red"; }

            if (maxMist < Mistakes)
            { document.getElementById("mistakes").style.color = "red"; }

            document.getElementById("next-btn").innerText = "Заново";
            document.getElementById("result-box").style.display = "block";
        }
    }
    function timer() {
        if (isTyping == "t") {
            timeSpan = timeSpan + 1;
        }
    };
    setInterval(timer, 100);

    document.onload = new function () { highLight(document.getElementsByClassName('not-done')[0].innerText[0], "Caps"); }

    document.onkeypress = function (e) {

        e = e || event;

        if (e.ctrlKey || e.altKey || e.metaKey) return;


        var ch = String.fromCharCode(e.keyCode);
        //alert(e.keyCode);
        //alert(document.getElementById('not-done').innerText);
        //alert(document.getElementById('not-done').innerHTML);
        //alert(document.getElementById('not-done').innerText[0] == ch);

        //alert(ch);
        //if (e.keyCode == 32 && document.getElementById('not-done').innerText[0] == " ") {
        //    document.getElementsByClassName('done')[0].innerText += " ";
        //    document.getElementsByClassName('not-done')[0].innerText =
        //        document.getElementsByClassName('not-done')[0].innerText.substring(1,
        //        document.getElementsByClassName('not-done')[0].innerText.length);

        //    if (document.getElementById('not-done').innerText.length > 0)
        //    {
        //        highLight(document.getElementById('not-done').innerText[0]);
        //        fadeLight(ch);
        //    }
        //    else
        //    {
        //        fadeLight(ch);
        //    }
        //}


        if (document.getElementById('not-done').innerText[0] == ch) {

            if (isTyping == "f" && document.getElementById('done').innerText == "")
            { isTyping = "t"; }


            document.getElementsByClassName('done')[0].innerText += ch;
            document.getElementsByClassName('not-done')[0].innerText =
                document.getElementsByClassName('not-done')[0].innerText.substring(1,
                document.getElementsByClassName('not-done')[0].innerText.length);

            if (isTyping == "t" && document.getElementById('not-done').innerText == "") {
                isTyping = "f";
                ShowResult();
            }

            if (document.getElementById('not-done').innerText.length > 0) {
                fadeLight(ch);
                highLight(document.getElementById('not-done').innerText[0]);
            }
            else {
                fadeLight(ch);
            }
        }
        else {
            Mistakes += 1;
            document.getElementById("mst").innerText = Mistakes;
            MakeRed(ch);
            setTimeout(MakeNormal, 75, ch);
        }
    }
    function fadeLight(key) {
        if (key == " ") {
            document.getElementById("Space1").style.border = "1px solid #5c5b5b";
            document.getElementById("Space1").style.margin = "0px";
            document.getElementById("Space1").style.marginTop = "2px";
            document.getElementById("Space2").style.border = "1px solid #5c5b5b";
            document.getElementById("Space2").style.margin = "0px";
            document.getElementById("Space2").style.marginTop = "2px";
            return;
        }
        if (document.getElementById(key) == null) return;
        document.getElementById(key).style.border = "1px solid #5c5b5b";
        document.getElementById(key).style.margin = "0px";
        document.getElementById(key).style.marginTop = "2px";
    }
    function highLight(key) {
        if (key == " ") {
            document.getElementById("Space1").style.border = "2px solid white";
            document.getElementById("Space1").style.margin = "0px";
            document.getElementById("Space1").style.marginTop = "1px";
            document.getElementById("Space2").style.border = "2px solid white";
            document.getElementById("Space2").style.margin = "0px";
            document.getElementById("Space2").style.marginTop = "1px";
        }
        if (document.getElementById(key) == null) return;
        document.getElementById(key).style.border = "2px solid white";
        document.getElementById(key).style.margin = "0px";
        document.getElementById(key).style.marginTop = "1px";
    }
    function MakeRed(key) {
        if (key == " ") {
            document.getElementById("Space1").style.backgroundColor = "red";
            document.getElementById("Space2").style.backgroundColor = "red";
        } else {
            document.getElementById(key).style.backgroundColor = "red";
        }
    }
    function MakeNormal(key) {
        if (key == " ") {
            document.getElementById("Space1").style.backgroundColor = document.getElementsByClassName("key")[0].style.backgroundColor;
            document.getElementById("Space2").style.backgroundColor = document.getElementsByClassName("key")[0].style.backgroundColor;
        } else {
            document.getElementById(key).style.backgroundColor = document.getElementsByClassName("key")[0].style.backgroundColor;
        }
    }


</script>

<script>

    function setShiftDown() {
        if (event.shiftKey) {

            document.getElementById('kb2').style.display = "block";
            document.getElementById('kb1').style.display = "none";

            //var elem = document.getElementsByClassName("letter");
            //for (var i = 0; i < elem.length; i++) {
            //    elem[i].c
            //    elem[i].textContent = elem[i].textContent.toUpperCase();
            //}
            //document.getElementById(1).textContent = "!";
            //document.getElementById(2).textContent = "\"";
            //document.getElementById(3).textContent = "№";
            //document.getElementById(4).textContent = ";";
            //document.getElementById(5).textContent = "%";
            //document.getElementById(6).textContent = ":";
            //document.getElementById(7).textContent = "?";
            //document.getElementById(8).textContent = "*";;
            //document.getElementById(9).textContent = "(";
            //document.getElementById(0).textContent = ")";
            //document.getElementById("-").textContent = "_";
            //document.getElementById("=").textContent = "+";
            //document.getElementById("\\").textContent = "/";
            //document.getElementById(".").textContent = ",";


            //highLight(document.getElementById('not-done').innerText[0].toLowerCase());
        }
    };
    function setShiftUp() {
        if (!event.shiftKey) {
            document.getElementById('kb1').style.display = "block";
            document.getElementById('kb2').style.display = "none";

            //if (!event.shiftKey) {
            //    var elem = document.getElementsByClassName("letter");
            //    for (var i = 0; i < elem.length; i++) {
            //        elem[i].textContent = elem[i].textContent.toLowerCase();
            //    }
            //    document.getElementById(1).textContent = "1";
            //    document.getElementById(2).textContent = "2";
            //    document.getElementById(3).textContent = "3";
            //    document.getElementById(4).textContent = "4";
            //    document.getElementById(5).textContent = "5";
            //    document.getElementById(6).textContent = "6";
            //    document.getElementById(7).textContent = "7";
            //    document.getElementById(8).textContent = "8";;
            //    document.getElementById(9).textContent = "9";
            //    document.getElementById(0).textContent = "0";
            //    document.getElementById("-").textContent = "-";
            //    document.getElementById("=").textContent = "=";
            //    document.getElementById("\\").textContent = "\\";
            //    document.getElementById(".").textContent = ".";

            //    fadeLight(document.getElementById('not-done').innerText[0].toLowerCase());
            //}
        }
    }
    function blinking() {
        if (document.getElementById('cursor').style.visibility == 'hidden')
            document.getElementById('cursor').style.visibility = 'visible';
        else
            document.getElementById('cursor').style.visibility = 'hidden';
    }

    setInterval(blinking, 300);

    document.onkeydown = setShiftDown;
    document.onkeyup = setShiftUp;
</script>
